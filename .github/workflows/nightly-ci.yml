name: JAX-AITER Nightly CI

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'  # 01:00 UTC daily.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: [linux-mi355-8]

    env:
      IMAGE: rocm/jax:rocm7.0.2-jax0.6.0-py3.12-ubu24
      CONTAINER_NAME: rv_aiter_ci
      WORKDIR: /workspace
      JA_ROOT_DIR: /jax-aiter
      AITER_SYMBOL_VISIBLE: 1
      GPU_ARCHS: "gfx942;gfx950"
      AITER_ASM_DIR: /jax-aiter/third_party/aiter/hsa/gfx950
      ROCM_VERSION: 7.0.2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Initialize required submodules only
        run: |
          set -euxo pipefail
          # Initialize JAX-AITER top-level submodules
          git submodule update --init third_party/pytorch third_party/aiter
          
          # Initialize PyTorch's necessary nested submodules
          cd third_party/pytorch
          git submodule update --init \
              third_party/cpuinfo \
              third_party/sleef \
              third_party/protobuf \
              third_party/onnx \
              third_party/fmt \
              third_party/FP16 \
              third_party/FXdiv \
              third_party/psimd \
              third_party/pthreadpool \
              third_party/pybind11 \
              third_party/pocketfft \
              third_party/composable_kernel \
              third_party/nlohmann \
              third_party/kineto \
              third_party/flatbuffers
          cd ../..
          
          # Initialize AITER submodules
          cd third_party/aiter
          git submodule update --init 3rdparty/composable_kernel
          cd ../..

      - name: Print host info
        run: |
          set -euxo pipefail
          whoami
          id -u; id -g
          uname -a
          docker --version
          rocm-smi || true

      - name: Pull container image
        run: docker pull "$IMAGE"

      - name: Launch build container (ROCm + big shm + devices + env)
        run: |
          set -euxo pipefail
          docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
          docker run -d --name "$CONTAINER_NAME" \
            --network=host \
            --device=/dev/kfd \
            --device=/dev/dri \
            --ipc=host \
            --shm-size=64G \
            --group-add=video \
            --cap-add=SYS_PTRACE \
            --security-opt seccomp=unconfined \
            -e JA_ROOT_DIR="${{ env.JA_ROOT_DIR }}" \
            -e AITER_SYMBOL_VISIBLE="${{ env.AITER_SYMBOL_VISIBLE }}" \
            -e GPU_ARCHS="${{ env.GPU_ARCHS }}" \
            -e AITER_ASM_DIR="${{ env.AITER_ASM_DIR }}" \
            -v "${{ github.workspace }}:/jax-aiter" \
            -w "/jax-aiter" \
            "$IMAGE" tail -f /dev/null

      - name: Setup GPU environment
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            # Detect and set visible GPUs
            HIP_DEVICES=$(rocm-smi -i | awk -F'\''[][]'\'' '\''/GPU\[/{print $2}'\'' | sort -n | uniq | paste -sd, -)
            echo "HIP_VISIBLE_DEVICES=$HIP_DEVICES" | tee -a /etc/environment
            echo "Detected GPUs: $HIP_DEVICES"
            # Make it available for all subsequent commands
            echo "export HIP_VISIBLE_DEVICES=$HIP_DEVICES" >> ~/.bashrc
          '

      - name: Ensure base tooling inside container
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              git ca-certificates curl build-essential pkg-config
            python3 -m pip install --break-system-packages cmake ninja pyyaml pytest pytest-xdist pytest-rerunfailures
            git --version
          '

      - name: Mark repos safe for Git (inside container)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -eux
            git config --global --add safe.directory /jax-aiter
            git config --global --add safe.directory /jax-aiter/third_party/pytorch
            git config --global --add safe.directory /jax-aiter/third_party/aiter
          '

      - name: Display environment (in container)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            echo "========================================="
            echo "System Information"
            echo "========================================="
            echo "Container whoami: $(whoami || true)"
            echo "Container uid: $(id -u), gid: $(id -g)"
            echo "Working directory: $PWD"
            echo "Processors: $(nproc)"
            echo ""
            echo "ROCm SMI:"; rocm-smi || echo "rocm-smi not available"
            echo ""
            echo "ROCm Info (GPU details):"; rocminfo | grep -E "Marketing Name:|gfx" || true
            echo ""
            echo "========================================="
            echo "Environment Variables"
            echo "========================================="
            env
            echo "========================================="
          '

      - name: Apply PyTorch patch
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            cd third_party/pytorch
            git apply ../../scripts/torch_caffe.patch
          '

      - name: Apply AITER patch
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            cd third_party/aiter
            git apply ../../scripts/aiter.patch
          '

      - name: Build static PyTorch (full)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            rm -rf third_party/pytorch/build_static
            bash ./scripts/build_static_pytorch.sh
            echo "PyTorch static build completed"
            ls -la third_party/pytorch/build_static/lib/
          '

      - name: Build umbrella shared library
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            make
            ls -lh build/jax_aiter_build/libjax_aiter.so
          '

      - name: Build JIT modules
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 jax_aiter/jit/build_jit.py
            ls -lh build/aiter_build/*.so
          '

      - name: Build JA frontend modules
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            make ja_mods
            ls -lh build/jax_aiter_build/*.so
          '

      - name: Install ROCm PyTorch runtime wheel
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 -m pip install --break-system-packages \
             --find-links https://repo.radeon.com/rocm/manylinux/rocm-rel-7.0.2/ \
             'torch==2.8.0+rocm7.0.2.lw.git245bf6ed'
          '

      - name: Install AITER
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pip install --break-system-packages third_party/aiter
          '

      - name: Install JAX-AITER
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pip install --break-system-packages .
          '

      - name: Run smoke test
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 -c "from jax_aiter.mha import flash_attn_func, flash_attn_varlen; print(\"jax-aiter import successful\")"
            python tests/smoke_mha_test.py --focus comprehensive
          '

      - name: Run tests
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail

            # Run MHA tests in parallel across GPUs and save failures
            python tests/multi_gpu_runner.py tests/test_mha_ja.py --save-failed failed_mha.txt || true
            if [ -s failed_mha.txt ]; then
              echo "Failed MHA tests count: $(sort -u failed_mha.txt | wc -l)"
              echo "Failed MHA tests:"
              sort -u failed_mha.txt
            else
              echo "No MHA test failures"
            fi

            # Run Varlen tests in parallel across GPUs and save failures
            python tests/multi_gpu_runner.py tests/test_mha_varlen_ja.py --save-failed failed_varlen.txt || true
            if [ -s failed_varlen.txt ]; then
              echo "Failed Varlen tests count: $(sort -u failed_varlen.txt | wc -l)"
              echo "Failed Varlen tests:"
              sort -u failed_varlen.txt
            else
              echo "No Varlen test failures"
            fi

            # Combined failures for convenience
            cat failed_mha.txt failed_varlen.txt 2>/dev/null | sort -u > failed_tests.txt || true
            if [ -s failed_tests.txt ]; then
              echo "Total failed tests: $(wc -l < failed_tests.txt)"
              echo "All failed tests:"
              cat failed_tests.txt
            else
              echo "No test failures across MHA and Varlen suites"
            fi

            # Optional benchmark
            python benchmarks/benchmark_mha.py
          ' || echo "::warning::Tests reported failures; continuing without failing the step"

      - name: Build summary
        if: always()
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            echo "========================================="
            echo "Build Summary"
            echo "========================================="
            echo "PyTorch static libs:"; ls -lh third_party/pytorch/build_static/lib/lib*.a 2>/dev/null || echo "Not found"
            echo ""
            echo "JAX-AITER umbrella library:"; ls -lh build/jax_aiter_build/libjax_aiter.so 2>/dev/null || echo "Not found"
            echo ""
            echo "AITER modules:"; ls -lh build/aiter_build/*.so 2>/dev/null || echo "None found"
            echo ""
            echo "JA modules:"; ls -lh build/jax_aiter_build/*.so 2>/dev/null || echo "None found"
            echo "========================================="
          '

      - name: Cleanup container
        if: always()
        run: docker rm -f "$CONTAINER_NAME" || true