name: JAX-AITER CI

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: [self-hosted, Linux, X64]

    env:
      IMAGE: rocm/jax:rocm7.0.2-jax0.6.0-py3.10-ubu22
      CONTAINER_NAME: rv_aiter_ci
      WORKDIR: /workspace
      JA_ROOT_DIR: /jax-aiter
      AITER_SYMBOL_VISIBLE: "1"
      GPU_ARCHS: "gfx942;gfx950"
      AITER_ASM_DIR: /jax-aiter/third_party/aiter/hsa/gfx950
      ROCM_VERSION: 7.0.2

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Detect workspace owner uid/gid
        id: owner
        run: |
          set -euo pipefail
          pair="$(stat -c '%u:%g' "${{ github.workspace }}")"
          echo "uid=${pair%%:*}" >> "$GITHUB_OUTPUT"
          echo "gid=${pair##*:}" >> "$GITHUB_OUTPUT"
          echo "Host user: $(id -un)  uid=${pair%%:*} gid=${pair##*:}"

      - name: Print host info
        run: |
          set -euxo pipefail
          whoami
          id -u; id -g
          uname -a
          docker --version
          rocm-smi || true

      - name: Pull container image
        run: docker pull "$IMAGE"

      - name: Launch build container (ROCm + big shm + devices + env)
        run: |
          set -euxo pipefail
          docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
          mkdir -p "${{ github.workspace }}/.home"
          docker run -d --name "$CONTAINER_NAME" \
            --network=host \
            --device=/dev/kfd \
            --device=/dev/dri \
            --ipc=host \
            --shm-size=64G \
            --group-add=video \
            --cap-add=SYS_PTRACE \
            --security-opt seccomp=unconfined \
            --user "${{ steps.owner.outputs.uid }}:${{ steps.owner.outputs.gid }}" \
            -e HOME=/home/runner \
            -e JA_ROOT_DIR="${{ env.JA_ROOT_DIR }}" \
            -e AITER_SYMBOL_VISIBLE="${{ env.AITER_SYMBOL_VISIBLE }}" \
            -e GPU_ARCHS="${{ env.GPU_ARCHS }}" \
            -e AITER_ASM_DIR="${{ env.AITER_ASM_DIR }}" \
            -e ROCM_VERSION="${{ env.ROCM_VERSION }}" \
            -e ROCM_PATH="/opt/rocm-${{ env.ROCM_VERSION }}" \
            -v "${{ github.workspace }}:/jax-aiter" \
            -v "${{ github.workspace }}/.home:/home/runner" \
            -w "/jax-aiter" \
            "$IMAGE" tail -f /dev/null

      - name: Ensure base tooling inside container (root for apt)
        run: |
          docker exec --user 0:0 "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              git ca-certificates curl build-essential pkg-config
            python3 -m pip install --upgrade pip
            python3 -m pip install cmake ninja pyyaml pytest pytest-xdist
            git --version
          '

      - name: Mark repos safe for Git (inside container)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -eux
            git config --global --add safe.directory /jax-aiter
            git config --global --add safe.directory /jax-aiter/third_party/pytorch
            git config --global --add safe.directory /jax-aiter/third_party/aiter
          '

      - name: Display environment (in container)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            echo "========================================="
            echo "System Information"
            echo "========================================="
            echo "Container whoami: $(whoami || true)"
            echo "Container uid: $(id -u), gid: $(id -g)"
            echo "Working directory: $PWD"
            echo "Processors: $(nproc)"
            echo ""
            echo "ROCm SMI:"; rocm-smi || echo "rocm-smi not available"
            echo ""
            echo "ROCm Info (GPU details):"; rocminfo | grep -E "Marketing Name:|gfx" || true
            echo ""
            echo "========================================="
            echo "Environment Variables"
            echo "========================================="
            env | grep -E "JA_ROOT_DIR|GPU_ARCHS|AITER_ASM_DIR|ROCM_PATH|ROCM_VERSION" || true
            echo "========================================="
          '

      - name: Apply PyTorch patch
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            cd third_party/pytorch
            git apply ../../scripts/torch_caffe.patch
          '

      - name: Apply AITER patch
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            cd third_party/aiter
            git apply ../../scripts/aiter_torch_remove.patch
          '

      # NEW: fast hipify-only step
      - name: HIPify PyTorch sources (only)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            bash ./scripts/build_static_pytorch.sh --hipify-only
            ls -l third_party/pytorch/.hipify_done
          '

      - name: Get PyTorch submodule SHA
        id: pytorch_sha
        run: echo "sha=$(git rev-parse HEAD:third_party/pytorch)" >> "$GITHUB_OUTPUT"

      - name: Get AITER submodule SHA
        id: aiter_sha
        run: echo "sha=$(git rev-parse HEAD:third_party/aiter)" >> "$GITHUB_OUTPUT"

      - name: Cache PyTorch static build
        id: cache-pytorch
        uses: actions/cache@v4
        with:
          path: |
            third_party/pytorch/build_static
            third_party/pytorch/.hipify_done
          key: >
            pytorch-static-${{ runner.os }}-img=${{ env.IMAGE }}
            -rocm=${{ env.ROCM_VERSION }}
            -arch=${{ env.GPU_ARCHS }}
            -submod=${{ steps.pytorch_sha.outputs.sha }}
            -patch=${{ hashFiles('scripts/build_static_pytorch.sh', 'scripts/torch_caffe.patch') }}
          restore-keys: |
            pytorch-static-${{ runner.os }}-img=${{ env.IMAGE }}-rocm=${{ env.ROCM_VERSION }}-arch=${{ env.GPU_ARCHS }}-
            pytorch-static-${{ runner.os }}-

      - name: Build static PyTorch (if cache miss)
        if: steps.cache-pytorch.outputs.cache-hit != 'true'
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            if [ -f third_party/pytorch/build_static/lib/libc10.a ] && [ -d third_party/pytorch/build_static/install/include ]; then
              echo "[pytorch-static] cache warm, skipping rebuild."
              exit 0
            fi
            bash ./scripts/build_static_pytorch.sh
            ls -la third_party/pytorch/build_static/lib/ || true
          '

      - name: Verify PyTorch build artifacts
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            ls -lh third_party/pytorch/build_static/lib/lib*.a
            ls -d third_party/pytorch/build_static/install/include
          '

      - name: Cache AITER artifacts
        uses: actions/cache@v4
        with:
          path: |
            build/hipified_aiter
            build/aiter_build
          key: >
            aiter-${{ runner.os }}-img=${{ env.IMAGE }}
            -rocm=${{ env.ROCM_VERSION }}
            -arch=${{ env.GPU_ARCHS }}
            -asm=${{ env.AITER_ASM_DIR }}
            -submod=${{ steps.aiter_sha.outputs.sha }}
            -patch=${{ hashFiles('scripts/aiter_torch_remove.patch') }}
          restore-keys: |
            aiter-${{ runner.os }}-img=${{ env.IMAGE }}-rocm=${{ env.ROCM_VERSION }}-arch=${{ env.GPU_ARCHS }}-
            aiter-${{ runner.os }}-

      - name: Build umbrella shared library
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            umask 0002
            make
            ls -lh build/aiter_build/libjax_aiter.so
          '

      - name: Build JIT modules
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            umask 0002
            python3 jax_aiter/jit/build_jit.py --module module_custom,libmha_bwd,libmha_fwd,module_fmha_v3_bwd,module_fmha_v3_fwd,module_fmha_v3_varlen_bwd,module_fmha_v3_varlen_fwd,module_mha_bwd,module_mha_fwd,module_mha_varlen_bwd,module_mha_varlen_fwd
            ls -lh build/aiter_build/*.so
          '

      - name: Build JA frontend modules
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            umask 0002
            make ja_mods
            ls -lh build/jax_aiter_build/*.so
          '

      - name: Install ROCm PyTorch runtime wheel
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 -m pip install --upgrade pip
            pip install --find-links https://repo.radeon.com/rocm/manylinux/rocm-rel-7.0/ \
              torch==2.8.0+rocm7.0.0.git64359f59
          '

      - name: Install AITER (editable)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pip install -e third_party/aiter
          '

      - name: Install JAX-AITER (editable)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pip install -e .
          '

      - name: Run smoke test
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 -c "from jax_aiter.mha import flash_attn_func, flash_attn_varlen; print(\"jax-aiter import successful\")"
          '

      - name: Run tests
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pytest -n 8 --dist=loadscope --reruns 4 -q tests/test_mha_varlen_ja.py
            pytest -n 8 --dist=loadscope --reruns 4 -q tests/test_mha_ck_ja.py
          '

      - name: Build summary
        if: always()
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            echo "========================================="
            echo "Build Summary"
            echo "========================================="
            echo "PyTorch static libs:"; ls -lh third_party/pytorch/build_static/lib/lib*.a 2>/dev/null || echo "Not found"
            echo ""
            echo "JAX-AITER umbrella library:"; ls -lh build/aiter_build/libjax_aiter.so 2>/dev/null || echo "Not found"
            echo ""
            echo "AITER modules:"; ls -lh build/aiter_build/*.so 2>/dev/null || echo "None found"
            echo ""
            echo "JA modules:"; ls -lh build/jax_aiter_build/*.so 2>/dev/null || echo "None found"
            echo "========================================="
          '

      - name: Cleanup container
        if: always()
        run: docker rm -f "$CONTAINER_NAME" || true
