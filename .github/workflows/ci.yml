name: JAX-AITER CI

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: [self-hosted, Linux, X64]

    env:
      IMAGE: rocm/jax:rocm7.0.2-jax0.6.0-py3.12-ubu24
      CONTAINER_NAME: rv_aiter_ci
      WORKDIR: /workspace
      JA_ROOT_DIR: /jax-aiter
      AITER_SYMBOL_VISIBLE: 1
      GPU_ARCHS: "gfx942;gfx950"
      AITER_ASM_DIR: /jax-aiter/third_party/aiter/hsa/gfx950
      ROCM_VERSION: 7.0.2

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get third_party/aiter submodule SHA
        id: aiter_sha
        run: echo "sha=$(git -C third_party/aiter rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Print host info
        run: |
          set -euxo pipefail
          whoami
          id -u; id -g
          uname -a
          docker --version
          rocm-smi || true

      - name: Create aiter_build directory
        run: mkdir -p build/aiter_build

      - name: Restore AITER JIT modules cache
        id: aiter_cache
        uses: actions/cache@v4
        with:
          path: |
            build/aiter_build/*.so
          key: >
            aiter-so-${{ runner.os }}
            -aiter-${{ steps.aiter_sha.outputs.sha }}
            -jit-${{ hashFiles('jax_aiter/jit/**') }}
            -cfg-${{ hashFiles('scripts/**','**/optCompilerConfig.json') }}

      - name: Pull container image
        run: docker pull "$IMAGE"

      - name: Launch build container (ROCm + big shm + devices + env)
        run: |
          set -euxo pipefail
          docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
          docker run -d --name "$CONTAINER_NAME" \
            --network=host \
            --device=/dev/kfd \
            --device=/dev/dri \
            --ipc=host \
            --shm-size=64G \
            --group-add=video \
            --cap-add=SYS_PTRACE \
            --security-opt seccomp=unconfined \
            -e JA_ROOT_DIR="${{ env.JA_ROOT_DIR }}" \
            -e AITER_SYMBOL_VISIBLE="${{ env.AITER_SYMBOL_VISIBLE }}" \
            -e GPU_ARCHS="${{ env.GPU_ARCHS }}" \
            -e AITER_ASM_DIR="${{ env.AITER_ASM_DIR }}" \
            -v "${{ github.workspace }}:/jax-aiter" \
            -w "/jax-aiter" \
            "$IMAGE" tail -f /dev/null

      - name: Setup GPU environment
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            # Detect and set visible GPUs
            HIP_DEVICES=$(rocm-smi -i | awk -F'\''[][]'\'' '\''/GPU\[/{print $2}'\'' | sort -n | uniq | paste -sd, -)
            echo "HIP_VISIBLE_DEVICES=$HIP_DEVICES" | tee -a /etc/environment
            echo "Detected GPUs: $HIP_DEVICES"
            # Make it available for all subsequent commands
            echo "export HIP_VISIBLE_DEVICES=$HIP_DEVICES" >> ~/.bashrc
          '

      - name: Ensure base tooling inside container
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              git ca-certificates curl build-essential pkg-config
            python3 -m pip install --break-system-packages cmake ninja pyyaml pytest pytest-xdist
            git --version
          '

      - name: Mark repos safe for Git (inside container)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -eux
            git config --global --add safe.directory /jax-aiter
            git config --global --add safe.directory /jax-aiter/third_party/pytorch
            git config --global --add safe.directory /jax-aiter/third_party/aiter
          '

      - name: Display environment (in container)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            echo "========================================="
            echo "System Information"
            echo "========================================="
            echo "Container whoami: $(whoami || true)"
            echo "Container uid: $(id -u), gid: $(id -g)"
            echo "Working directory: $PWD"
            echo "Processors: $(nproc)"
            echo ""
            echo "ROCm SMI:"; rocm-smi || echo "rocm-smi not available"
            echo ""
            echo "ROCm Info (GPU details):"; rocminfo | grep -E "Marketing Name:|gfx" || true
            echo ""
            echo "========================================="
            echo "Environment Variables"
            echo "========================================="
            env
            echo "========================================="
          '

      - name: Apply PyTorch patch
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            cd third_party/pytorch
            git apply ../../scripts/torch_caffe.patch
          '

      - name: Apply AITER patch
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            cd third_party/aiter
            git apply ../../scripts/aiter.patch
          '

      - name: Build static PyTorch (full)
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            rm -rf third_party/pytorch/build_static
            bash ./scripts/build_static_pytorch.sh
            echo "PyTorch static build completed"
            ls -la third_party/pytorch/build_static/lib/
          '

      - name: Build umbrella shared library
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            make
            ls -lh build/jax_aiter_build/libjax_aiter.so
          '

      - name: Check if JIT outputs exist
        id: have_jit
        run: |
          set -euo pipefail
          cnt=0
          if ls build/aiter_build/*.so >/dev/null 2>&1; then
            cnt=$(ls build/aiter_build/*.so | wc -l)
          fi
          echo "count=$cnt" >> "$GITHUB_OUTPUT"

      - name: Decide whether to build JIT
        id: jit_decision
        shell: bash
        run: |
          set -euo pipefail
          cache_hit='${{ steps.aiter_cache.outputs.cache-hit }}'   # "true" if hit, empty if miss
          have_count='${{ steps.have_jit.outputs.count }}'         # "0" or a number

          # Treat empty cache_hit as "false"
          if [[ "${cache_hit:-}" == "true" && "${have_count}" != "0" ]]; then
            echo "do_build=false" >> "$GITHUB_OUTPUT"
            echo "Cache hit & ${have_count} .so files present. SKIP JIT."
          else
            echo "do_build=true" >> "$GITHUB_OUTPUT"
            echo "No/empty cache (cache_hit=${cache_hit:-<none>}, count=${have_count}). BUILD JIT."
          fi

      - name: Build JIT modules
        if: steps.jit_decision.outputs.do_build == 'true'
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 jax_aiter/jit/build_jit.py
            ls -lh build/aiter_build/*.so
          '

      - name: Save AITER JIT modules cache
        if: steps.jit_decision.outputs.do_build == 'true' && steps.aiter_cache.outputs.cache-hit != 'true' && hashFiles('build/aiter_build/*.so') != ''
        uses: actions/cache/save@v4
        with:
          path: |
            build/aiter_build/*.so
          key: >
            aiter-so-${{ runner.os }}
            -aiter-${{ steps.aiter_sha.outputs.sha }}
            -jit-${{ hashFiles('jax_aiter/jit/**') }}
            -cfg-${{ hashFiles('scripts/**','**/optCompilerConfig.json') }}

      - name: Build JA frontend modules
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            make ja_mods
            ls -lh build/jax_aiter_build/*.so
          '

      - name: Install ROCm PyTorch runtime wheel
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            for i in {1..3}; do
              echo "Attempt $i: Installing PyTorch..."
              if python3 -m pip install --break-system-packages \
                --default-timeout=300 \
                --retries 5 \
                --find-links https://repo.radeon.com/rocm/manylinux/rocm-rel-7.0.2/ \
                '\''torch==2.8.0+rocm7.0.2.lw.git245bf6ed'\''; then
                echo "PyTorch installed successfully"
                break
              fi
              if [ $i -eq 3 ]; then
                echo "Failed to install PyTorch after 3 attempts"
                exit 1
              fi
              echo "Attempt $i failed, retrying..."
              sleep 10
            done
          '

      - name: Install AITER
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pip install --break-system-packages third_party/aiter
          '

      - name: Install JAX-AITER
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            pip install --break-system-packages .
          '

      - name: Run smoke test
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            python3 -c "from jax_aiter.mha import flash_attn_func, flash_attn_varlen; print(\"jax-aiter import successful\")"
            python tests/smoke_mha_test.py --focus comprehensive
          '

      - name: Run tests
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            pytest -n 8 --dist=loadscope --reruns 4 -q tests/test_mha_varlen_ja.py
            python tests/multi_gpu_runner.py --save-failed failed_tests.txt
            if [ -f failed_tests.txt ]; then
              echo "Failed tests count: $(sort failed_tests.txt | uniq | wc -l)"
              echo "Failed tests:"
              sort failed_tests.txt | uniq
            fi
            python benchmarks/benchmark_mha.py
          ' || echo "::warning::Pytest reported failures; continuing without failing the step"

      - name: Build summary
        if: always()
        run: |
          docker exec "$CONTAINER_NAME" bash -lc '
            set -euxo pipefail
            echo "========================================="
            echo "Build Summary"
            echo "========================================="
            echo "PyTorch static libs:"; ls -lh third_party/pytorch/build_static/lib/lib*.a 2>/dev/null || echo "Not found"
            echo ""
            echo "JAX-AITER umbrella library:"; ls -lh build/jax_aiter_build/libjax_aiter.so 2>/dev/null || echo "Not found"
            echo ""
            echo "AITER modules:"; ls -lh build/aiter_build/*.so 2>/dev/null || echo "None found"
            echo ""
            echo "JA modules:"; ls -lh build/jax_aiter_build/*.so 2>/dev/null || echo "None found"
            echo "========================================="
          '

      - name: Cleanup container
        if: always()
        run: docker rm -f "$CONTAINER_NAME" || true
